## 简介
Tcp是一个面向连接，基于字节流的，可靠的传输层协议。建立连接需经历三次握手，断开连接需经历四次挥手。Tcp提供了流量控制，拥塞控制，超时重传，丢包重传等功能。Tcp的可靠性是通过序列号，确认号，滑动窗口，超时重传，丢包重传等机制实现的。

## 概念
- **SYN：**（Synchronize Sequence Numbers）同步序列编号，TCP建立连接时使用的握手信号。

- **ACK：**（Acknowledge character）确认字符，表示接收到的字符无错误

- **三次握手：** 建立一个TCP连接时，需要客户端和服务端总共发送三个包以确认连接的建立
  - 第一次握手：Client将标志SYN=1，随机产生一个值seq=J，并将该数据包发送给Server，Client进入SYN_SENT状态，等待Server确认。
  - 第二次握手：Server收到数据包后由标志位SYN=1知道Client请求建立连接，Server将标志位SYN和ACK都置为1，ack=J+1，随机产生一个值seq=K，并将该数据包发送给Client以确认连接请求，Server进入SYN_RCVD状态。
  - 第三次握手：Client收到确认后，检查ack是否为J+1，ACK是否为1，如果正确则将标志位ACK置为1，ack=K+1，并将该数据包发送给Server，Server检查ack是否为K+1，ACK是否为1，如果正确则连接建立成功，Client和Server进入ESTABLISHED状态，完成三次握手。
  
- **为什么是三次握手，而不是两次：** 若建立连接只需两次握手，此时如果网络拥塞，客户端发送的连接请求迟迟到不了服务端，客户端便超时重发请求，如果服务端正确接收并确认应答，双方便开始通信，通信结束后释放连接。此时，如果那个失效的连接请求抵达了服务端，由于只有两次握手，服务端收到请求就会进入ESTABLISHED状态，等待发送数据或主动发送数据。但此时的客户端早已进入CLOSED状态，服务端将会一直等待下去，这样浪费服务端连接资源。

- **四次挥手：** 断开一个TCP连接时，需要客户端和服务端总共发送四个包来确定连接的断开
  - 第一次挥手：Client发送一个FIN，用来关闭Client到Server的数据传送，Client进入FIN_WAIT_1状态。
  - 第二次挥手：Server收到FIN后，发送一个ACK给Client，确认序号为收到序号+1（与SYN相同，一个FIN占用一个序号），Server进入CLOSE_WAIT状态。
  - 第三次挥手：Server发送一个FIN，用来关闭Server到Client的数据传送，Server进入LAST_ACK状态。
  - 第四次挥手：Client收到FIN后，Client进入TIME_WAIT状态，接着发送一个ACK给Server，确认序号为收到序号+1，Server进入CLOSED状态，完成四次挥手
  
- **为什么握手要三次，挥手却要四次：** 因为握手的时候并没有数据传输，所以服务端的SYN和ACK报文可以一起发送，但是挥手的时候有数据在传输，所以ACK和FIN报文不能同时发送，需要分两步，所以会比握手多一步。

- **为什么客户端在第四次挥手后还会等待2MSL（即4分钟）：** 等待2MSL是因为保证服务端接收到了ACK报文，因为网络很复杂，有可能ACK报文丢失了，如果服务端没接收到ACK报文的话，会重新发送FIN报文，只有当客户端等待了2MSL都没有收到重发的FIN报文时就表示服务端是正常收到了ACK报文，那么这个时候客户端就可以关闭了